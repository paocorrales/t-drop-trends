---
title: "Preparing your manuscript"
format:
    agu-pdf:
        keep-tex: true
    agu-html: default
author:
  - name: Michael J Mahoney
    affiliations:
      - name: State University of New York College of Environmental Science and Forestry
        department: Graduate Program in Environmental Science
        address: 1 Forestry Drive
        city: Syracuse
        region: NY
        country: USA
        postal-code: 13210
    orcid: 0000-0003-2402-304X
    email: fake_email@fakeyfake.com
    url: https://mm218.dev
    acknowledgements: Translated template to Quarto.
  - name: Charles Teague
    affiliations:
      - name: Posit, PBC
        address: 250 Northern Ave
        city: Boston
        region: Massachusetts
        country: USA
        postal-code: 02210
    corresponding: true
    orcid: 0000-0001-8715-9476
    email: charles@posit.co
abstract: |
  The abstract (1) states the nature of the investigation and (2) summarizes the important conclusions. The abstract should be suitable for indexing. Your abstract should:

    - Be set as a single paragraph.
    - Be less than 250 words for all journals except GRL, for which the limit is 150 words.
    - Not include table or figure mentions.
    - Avoid reference citations unless dependent on or directly related to another paper (e.g., companion, comment, reply, or commentary on another paper(s)). AGUâ€™s Style Guide discusses formatting citations in abstracts.
    - Define all abbreviations.
plain-language-summary: |
  A Plain Language Summary (PLS) can be an incredibly effective science communication tool. By summarizing your paper in non-technical terms, you can explain your research and its relevance to a much broader audience. A PLS is required for submissions to AGU Advances, G-Cubed, GeoHealth, GRL, JAMES, JGR: Biogeosciences, JGR: Oceans, JGR: Planets, JGR: Solid Earth, JGR: Atmospheres, Space Weather, and Reviews of Geophysics, but optional for other journals.  A PLS should be no longer than 200 words and should be free of jargon, acronyms, equations, and any technical information that would be unknown to people from outside your scientific discipline. Read our tips for creating an effective PLS.
keywords: []
key-points:
  - Key Points convey the main points and conclusions of the article. 
  - Up to three key point statements are allowed, and each is limited to at most 140 characters with no abbreviations.
  - Key Points are not included in the word count.
bibliography: bibliography.bib  
citation:
  container-title: Geophysical Research Letters
keep-tex: true
date: last-modified
execute: 
  cache: true
  echo: false
  message: false
  warning: false
---

```{r}
#| label: setup

library(metR)
library(ggplot2)
library(data.table)
library(lubridate)
library(here)
library(cowplot)

global_map <- rnaturalearth::ne_coastline()
models_in_gadi <- c("CMCC-ESM2", "EC-Earth3", "INM-CM4-8", "INM-CM5-0", 
                    "MPI-ESM1-2-HR", "NorESM2-MM", "EC-Earth3-CC", "EC-Earth3-Veg",
                    "EC-Earth3-Veg-LR", "GFDL-CM4")
```



## Introduction

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vestibulum hendrerit facilisis velit sit amet malesuada. Phasellus ornare nibh augue, maximus sodales ex tristique vitae. Vivamus non sollicitudin orci, aliquam placerat metus. Maecenas volutpat orci felis, vel finibus urna consectetur sed. Integer in dui ac dui mollis imperdiet. Quisque sed dapibus nibh. Aenean non luctus leo. Phasellus luctus mauris id aliquet dictum. Aliquam fermentum semper massa, vel dignissim nibh dictum et. See @Hubbard2021.

Phasellus interdum tincidunt ex, a euismod massa pulvinar at. Ut fringilla ut nisi nec volutpat. Morbi imperdiet congue tincidunt. Vivamus eget rutrum purus. Etiam et pretium justo. Donec et egestas sem. Donec molestie ex sit amet viverra egestas. Nullam justo nulla, fringilla at iaculis in, posuere non mauris. Ut eget imperdiet elit.

In luctus mauris vitae imperdiet luctus. Morbi volutpat ligula ut tortor fermentum, eu ornare felis luctus. Donec semper diam vitae mattis posuere. Suspendisse facilisis purus nisi, sit amet egestas ex tempor ut. Cras tortor nulla, euismod at fermentum vel, dictum vel justo. Aenean commodo interdum diam nec placerat. Nunc vestibulum felis at est tincidunt, at euismod dui vestibulum. Nulla venenatis tortor at auctor iaculis. Donec consectetur neque ut sagittis ornare. Nullam pharetra felis tempor suscipit efficitur. Curabitur nibh ex, euismod at congue hendrerit, egestas id mi. Duis porttitor neque in commodo elementum. Fusce vitae fermentum nisi, euismod viverra augue. Curabitur at mi pretium, accumsan purus nec, tempus turpis.

Donec non semper dui, quis aliquet est. Quisque quis sapien at massa ultricies egestas. Duis consequat ultricies erat, a pulvinar nisl vestibulum id. Sed tristique turpis ligula, et tempor lectus iaculis at. Vivamus commodo sapien ac turpis vestibulum dapibus. Morbi tristique arcu metus, et laoreet nisi varius nec. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Fusce sit amet nisl at mauris suscipit aliquet. Nulla vitae dignissim urna. Suspendisse sit amet arcu vitae magna blandit mattis. Vivamus convallis efficitur pulvinar. Sed cursus elit nulla. Sed porta, arcu a euismod pretium, odio dui lacinia lacus, ac vulputate nulla augue eget ex. Nullam consequat ligula sit amet mattis aliquam. Nulla risus urna, ultrices vel ullamcorper id, ornare viverra nunc.

Nunc in lobortis lacus. Duis maximus urna leo, varius sodales arcu interdum nec. Pellentesque imperdiet dolor in leo eleifend dapibus. Ut dapibus, lectus non viverra gravida, ipsum ex faucibus tellus, quis iaculis risus tellus eget augue. Nullam a viverra est. Cras velit nisi, interdum in lacus at, vehicula mattis elit. Curabitur eu viverra purus. Proin pellentesque, metus vitae congue convallis, lorem metus feugiat mi, sit amet auctor purus ligula bibendum ante. Nam id justo scelerisque, rhoncus lectus in, fermentum libero. Donec tincidunt egestas ex ac eleifend. Cras faucibus ipsum a nunc faucibus fermentum. Integer et maximus lacus. Nam dictum nibh id viverra convallis.

## Data and methods

```{r}
#| label: model-table

readr::read_rds(here("data/cmip_file_list_scenario.rds")) |> 
  _[nominal_resolution == "100 km" & source_id %in% models_in_gadi, 
    .(source_id, institution_id, nominal_resolution)] |> 
  unique(by = "source_id") |> 
  knitr::kable(col.names = c("Model", "Institution", "Original resolution"),
               caption = "List of models used for the analysis.") |> 
  kableExtra::kable_classic()
```



## Results

(ref:trend) a) Multimodel change in drops in temperature frequency (%, SSP5-8.5 2018-2100 minus Historical 1980-2000) and zonal mean change over sea b) and land c), each grey line represent the models listed in Table 1 and in black, the multimodel mean. 

```{r}
#| label: trend
#| fig-width: 10
#| fig-height: 5
#| fig.cap: (ref:trend)

data <- purrr::map(Sys.glob(here("data/eke_mean/*hist*mean.nc")), function(f) {
  
  message(f)
  meta <- unglue::unglue(basename(f), patterns = c("{var}_{model}_{scenario}_mean.nc", "{var}_{model}_{scenario}_mean.nc"))
  
  if (meta[[1]][["var"]] == "eke") {
    var <- "ua"
  } else {
    var <- "tasmax"
  }
  file_scenario <- here(paste0("data/eke_mean/", meta[[1]][["var"]], "_", meta[[1]][["model"]], "_ssp585_mean.nc"))
  
  ReadNetCDF(f, vars = c(hist = var)) |> 
    _[, let(ssp585 = ReadNetCDF(file_scenario, vars = c(ssp585 = var), out = "vector")[[1]])] |> 
    _[, let(model = meta[[1]][["model"]],
            var = meta[[1]][["var"]],
            change = ssp585 - hist,
            lat = round(lat, digits = 8),
            plev = NULL)] |> 
    _[]
  
}) |> rbindlist()



map_trend <- data |> 
  _[(model %in% models_in_gadi) & is.finite(change)] |>
  dcast(lat + lon + model ~ var, value.var = "change") |> 
  _[, .(mean_dt = mean(deltap97.5, na.rm = TRUE)), by = .(lon, lat)] |> 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_contour_fill(aes(z = mean_dt/365*100, fill = after_stat(level)),
                    breaks = c(-Inf, seq(-3, 3, 0.2), Inf)) +
  scale_fill_divergent_discretised(guide = guide_colorbar(barheight = 0.5),
                                   labels = function(x) JumpBy(x, 2, fill = "")) +
  geom_sf(data = global_map, inherit.aes = FALSE, fill = NA, linewidth = 0.2) +
  # scale_y_latitude(labels = NULL) +
  coord_sf(expand = FALSE) +
  labs(x = NULL, y = NULL, fill = "%") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        legend.frame = ggplot2::element_rect(color = "black", linewidth = 0.4),
        legend.key.width = grid::unit(1, 'null'),
        # axis.title.x=element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(), plot.margin = unit(c(0, 0 , 0 , 0), units = "mm")) 

mean_trend <- data |> 
  _[(model %in% models_in_gadi) & is.finite(change)] |>
  dcast(lat + lon + model ~ var, value.var = "change") |> 
  _[, let(land = MaskLand(lon, lat))] |> 
  _[, let(land = factor(land, labels = c("Sea", "Land")))] |> 
  _[, .(mean_dt = mean(deltap97.5, na.rm = TRUE)), by = .(lat, land, model)] |> 
  ggplot(aes(mean_dt, lat)) +
  geom_hline(yintercept = 0, color = "grey80") +
  geom_vline(xintercept = 0, color = "grey80") +
  geom_path(aes(group = model), color = "grey70", alpha = 0.7) +
  stat_summary(orientation = "y", geom = "line") +
  scale_y_latitude(breaks = seq(-80, 80 , 20)) +
  facet_wrap(~land) +
  tagger::tag_facets(tag_pool = c("b", "c")) +
  labs(x = "Change (%)") +
  coord_fixed(ratio = 1/2.8) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA),
        strip.text.x = element_text(size = 12),
        plot.margin = unit(c(0, 0 , 1.9, -0.40), units = "cm"),
        tagger.panel.tag.text = element_text(size = 12),
         tagger.panel.tag.background = element_rect(fill = "white", color = "white")) 

plot_grid(map_trend, mean_trend, labels = c('a)', ''), 
          label_x = 0, label_y = 0.9,
          label_fontface = "plain", 
          label_colour = "white",
          rel_widths = c(1.75, 1))

```





## Summary and Discussion

## Acknowledgments

Phasellus interdum tincidunt ex, a euismod massa pulvinar at. Ut fringilla ut nisi nec volutpat. Morbi imperdiet congue tincidunt. Vivamus eget rutrum purus. Etiam et pretium justo. Donec et egestas sem. Donec molestie ex sit amet viverra egestas. Nullam justo nulla, fringilla at iaculis in, posuere non mauris. Ut eget imperdiet elit.

## Open research

Phasellus interdum tincidunt ex, a euismod massa pulvinar at. Ut fringilla ut nisi nec volutpat. Morbi imperdiet congue tincidunt. Vivamus eget rutrum purus. Etiam et pretium justo. Donec et egestas sem. Donec molestie ex sit amet viverra egestas. Nullam justo nulla, fringilla at iaculis in, posuere non mauris. Ut eget imperdiet elit.

## References {.unnumbered}

:::{#refs}

:::